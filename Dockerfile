FROM ubuntu:20.04
LABEL org.opencontainers.image.authors="admin@0x434b.dev"

ENV DEBIAN_FRONTEND=noninteractive
ENV TERM="xterm"
ENV FORCE_UNSAFE_CONFIGURE=1 


RUN apt-get update && \
    apt-get -y install neovim make cmake build-essential git wget cpio python3 unzip file rsync bc libncurses-dev python-is-python3

COPY .config /in/.config
COPY Makefile.patch /in/Makefile.patch

# Install buildroot
WORKDIR /build
RUN git clone git://git.buildroot.net/buildroot && \
    cd buildroot && \
    git checkout 2018.08.x && \
    cp /in/.config .config && \ 
    make toolchain

ENV PATH=$PATH:/build/buildroot/output/host/usr/bin

COPY make.sh /in/make.sh
# Fetch Caraboot-ipq
WORKDIR /build
RUN git clone https://github.com/8devices/Caraboot-ipq.git && \
    cd Caraboot-ipq && \
    git checkout 8dev/jalapeno && \
    cp /in/make.sh make.sh && \
    chmod +x make.sh && \
    patch -p1 < /in/Makefile.patch

WORKDIR /build/Caraboot-ipq

# Entrypoint
CMD ["/bin/bash"]

